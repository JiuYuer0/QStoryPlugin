/*
åç§°: ç¾¤æŠ½å¥–åŠŸèƒ½ï¼ˆ@è§¦å‘äººç‰ˆï¼‰
è„šæœ¬id: GroupLuckyDraw
ä½œè€…: çŒ«çŒ«
è¯´æ˜: ä¿®å¤æ‰€æœ‰è¯­æ³•é”™è¯¯ï¼Œç¡®ä¿BeanShellè§£æé€šè¿‡
*/

// å…¨å±€å¸¸é‡
private static final String GROUP_ENABLED = "lottery_enabled_";
private static final String USER_COINS = "lottery_coins_";
private static final String USER_CHECKIN = "lottery_checkin_";
private static final String USER_CONTINUOUS_CHECKIN = "lottery_conti_";
private static final String USER_LAST_LOTTERY = "lottery_last_";
private static final String USER_CONTINUOUS_BAN = "lottery_ban_streak_";
private static final String DEV_MODE = "lottery_dev_mode_";
private static final String USER_ESCAPE_WINDOW = "lottery_escape_";
private static final String USER_BANNED = "lottery_banned_";
private static final String USER_BOMBS = "lottery_bombs_";
private static final String BOMB_LAST_CONFIG = "bomb_last_config";
private static final String USER_DAILY_LOTTERY = "lottery_daily_count_";

// é…ç½®å‚æ•°
private static final int BOMB_COST = 5;
private static final int BOMB_BAN_SECONDS = 60;
private static final int BOMB_TARGET_CHANCE = 60;
private static final int[] BAN_SECONDS = {60, 120, 180, 300};
private static final int[] ESCAPE_COST_MAP = {2, 3, 4, 5};
private static final int ESCAPE_WINDOW = 60000;
private static final int DAILY_FREE_COUNT = 5;
private static final int SELF_LOTTERY_BASE = 1;
private static final int HELP_LOTTERY_BASE = 3;

// å…³é”®è¯
private static final String ESCAPE_KEYWORD = "å…æ­»";
private static final String HELP_ESCAPE_KEYWORD = "å¸®@";
private static final String BOMB_AT_KEYWORD = "ç‚¸@";
private static final String BOMB_UP_KEYWORD = "ç‚¸æ¥¼ä¸Š";
private static final String BOMB_DOWN_KEYWORD = "ç‚¸æ¥¼ä¸‹";
private static final String SHOP_KEYWORD = "å•†åº—";
private static final String BUY_BOMB_KEYWORD = "è´­ä¹°ç‚¸å¼¹";
private static final String MSG_PREFIX = ",,";

// èœå•
AddItem("å¼€å¯æŠ½å¥–åŠŸèƒ½", "onEnableLottery");
AddItem("å…³é—­æŠ½å¥–åŠŸèƒ½", "onDisableLottery");
AddItem("æŸ¥è¯¢æˆ‘çš„é‡‘å¸", "onQueryMyCoins");
AddItem("å¼€å¯å¼€å‘è€…æ¨¡å¼", "onEnableDevMode");
AddItem("å…³é—­å¼€å‘è€…æ¨¡å¼", "onDisableDevMode");

// å…¨å±€å˜é‡
private long lastClickTime = 0;
private static final int CLICK_DELAY = 500;
private static final int LOTTERY_INTERVAL = 30000;
private static final int BAN_STREAK_LIMIT = 3;
private static final int BOMB_INTERVAL = 30000;
private Map lastSpeakerMap = new HashMap();
private Map pendingBombMap = new HashMap();

// å¥–åŠ±é…ç½®
private static final int[] CHECKIN_REWARDS = {0, 10, 12, 15};
private static final String[] REWARD_NAMES = {
    "è¢«ç¦è¨€1åˆ†é’Ÿ", "è¢«ç¦è¨€2åˆ†é’Ÿ", "è¢«ç¦è¨€3åˆ†é’Ÿ", "è¢«ç¦è¨€5åˆ†é’Ÿ",
    "è·å¾—1é‡‘å¸", "è·å¾—3é‡‘å¸", "è·å¾—5é‡‘å¸", "è·å¾—8é‡‘å¸"
};
private static final int[] REWARD_TYPES = {0,0,0,0,1,1,1,1};
private static final int[] REWARD_VALUES = {60, 120, 180, 300, 1, 3, 5, 8};
private static final int[] REWARD_WEIGHTS = {10, 8, 7, 5, 20, 18, 15, 9};

// å®Œæ•´æŠ½å¥–å¸®åŠ©
private static final String HELP_INFO = MSG_PREFIX + "ğŸ“‹ ç¾¤æŠ½å¥–åŠŸèƒ½å…¨æŒ‡å—ï¼š\n" +
    "ã€1. åŸºç¡€æŠ½å¥–ã€‘\n" +
    "â€¢ è‡ªå·±æŠ½ï¼šå‘é€ã€ŒæŠ½å¥–ã€ï¼Œæ¶ˆè€—1é‡‘å¸ï¼ˆæ¯æ—¥å‰5æ¬¡æ­£å¸¸ï¼Œç¬¬6æ¬¡èµ·æ¯æ¬¡å¤š1é‡‘å¸ï¼‰\n" +
    "â€¢ å¸®äººæŠ½ï¼šå‘é€ã€Œå¸®@æˆå‘˜æ˜µç§° æŠ½å¥–ã€ï¼Œæ¶ˆè€—3é‡‘å¸ï¼ˆè¶…é¢è§„åˆ™åŒä¸Šï¼‰\n" +
    "â€¢ è§„åˆ™ï¼šå¯èƒ½æŠ½ä¸­ç¦è¨€ï¼ˆ1/2/3/5åˆ†é’Ÿï¼‰æˆ–é‡‘å¸ï¼ˆ1/3/5/8é‡‘å¸ï¼‰ï¼Œè¿ç»­3æ¬¡ç¦è¨€åç¬¬4æ¬¡å¿…ä¸­é‡‘å¸\n" +
    "\nã€2. å…æ­»æœºåˆ¶ã€‘\n" +
    "â€¢ è‡ªå·±å…æ­»ï¼šæŠ½ä¸­ç¦è¨€å1åˆ†é’Ÿå†…å‘ã€Œå…æ­»ã€ï¼Œæ¶ˆè€—å¯¹åº”é‡‘å¸ï¼ˆ1åˆ†é’Ÿ2å¸/2åˆ†é’Ÿ3å¸/3åˆ†é’Ÿ4å¸/5åˆ†é’Ÿ5å¸ï¼‰\n" +
    "â€¢ å¸®äººå…æ­»ï¼šå‘ã€Œå¸®@æˆå‘˜æ˜µç§° å…æ­»ã€ï¼Œæ¶ˆè€—è‡ªå·±çš„é‡‘å¸å¸®å¯¹æ–¹æŠµæ¶ˆç¦è¨€\n" +
    "â€¢ è¶…æ—¶è§„åˆ™ï¼š1åˆ†é’Ÿå†…æœªæ“ä½œï¼Œè‡ªåŠ¨æ‰§è¡Œç¦è¨€\n" +
    "\nã€3. é‡‘å¸è·å–ä¸æŸ¥è¯¢ã€‘\n" +
    "â€¢ ç­¾åˆ°ï¼šå‘ã€Œç­¾åˆ°ã€æˆ–ã€Œå†’æ³¡ã€ï¼Œè¿ç»­ç­¾åˆ°å¥–åŠ±é€’å¢ï¼ˆ1å¤©10å¸/2å¤©12å¸/3å¤©åŠä»¥ä¸Š15å¸ï¼‰\n" +
    "â€¢ æŸ¥èµ„äº§ï¼šå‘ã€Œæˆ‘çš„é‡‘å¸ã€ï¼Œæ˜¾ç¤ºé‡‘å¸ã€ç‚¸å¼¹æ•°é‡ã€ä»Šæ—¥æŠ½å¥–æ¬¡æ•°åŠä¸‹æ¬¡æˆæœ¬\n" +
    "â€¢ æŸ¥ä»–äººï¼šå‘ã€ŒæŸ¥è¯¢@æˆå‘˜æ˜µç§° é‡‘å¸ã€ï¼ŒæŸ¥çœ‹å¯¹æ–¹é‡‘å¸å’ŒæŠ½å¥–æ¬¡æ•°\n" +
    "\nã€4. ç‚¸å¼¹åŠŸèƒ½ã€‘\n" +
    "â€¢ è´­ä¹°ï¼šå‘ã€Œå•†åº—ã€â†’ å‘ã€Œè´­ä¹°ç‚¸å¼¹ã€ï¼Œæ¶ˆè€—5é‡‘å¸å¾—1ä¸ªç‚¸å¼¹\n" +
    "â€¢ ä½¿ç”¨ï¼š\n" +
    "  - ç‚¸æŒ‡å®šäººï¼šã€Œç‚¸@æˆå‘˜æ˜µç§°ã€ï¼Œ60%æ¦‚ç‡å¯¹æ–¹ç¦è¨€1åˆ†é’Ÿï¼Œ40%æ¦‚ç‡è‡ªå·±ç¦è¨€\n" +
    "  - ç‚¸æ¥¼ä¸Šï¼šã€Œç‚¸æ¥¼ä¸Šã€ï¼Œå¯¹æœ€è¿‘ä¸€ä¸ªå‘è¨€è€…ä½¿ç”¨\n" +
    "  - ç‚¸æ¥¼ä¸‹ï¼šã€Œç‚¸æ¥¼ä¸‹ã€ï¼Œå¯¹ä¸‹ä¸€ä¸ªå‘è¨€è€…ä½¿ç”¨ï¼ˆä»…1æ¬¡æœ‰æ•ˆï¼‰\n" +
    "â€¢ é™åˆ¶ï¼šæ¯æ¬¡ä½¿ç”¨é—´éš”30ç§’ï¼Œéœ€å…ˆè´­ä¹°ç‚¸å¼¹\n" +
    "\nã€5. å…¶ä»–è¯´æ˜ã€‘\n" +
    "â€¢ æ‰€æœ‰æ“ä½œç»“æœä¼šè‡ªåŠ¨@è§¦å‘è€…ï¼Œé¿å…æ¶ˆæ¯æ··æ·†\n" +
    "â€¢ æŠ½å¥–/ç‚¸å¼¹æœ‰å†·å´æ—¶é—´ï¼Œæç¤ºä¸­ä¼šæ˜¾ç¤ºå‰©ä½™ç­‰å¾…æ—¶é—´";

// åˆå§‹åŒ–
void init() {}

// æ¶ˆæ¯å¤„ç†
void onMsg(Object msg) {
    if (!msg.IsGroup) return;
    String g = msg.GroupUin;
    String u = msg.UserUin;
    String c = msg.MessageContent.trim();
    boolean dev = getBoolean(DEV_MODE, g, false);
    boolean en = isGroupEnabled(g);
    
    updateLastSpeaker(g, u);
    checkPendingBomb(g, u);
    checkAllEscapeWindowTimeout(g);
    checkAllBannedStatus(g);

    // å…æ­»å¤„ç†
    if (en) {
        if (c.equals(ESCAPE_KEYWORD)) {
            handleEscape(g, u, u);
            return;
        }
        if (c.startsWith(HELP_ESCAPE_KEYWORD) && c.endsWith(ESCAPE_KEYWORD) && msg.mAtList != null && !msg.mAtList.isEmpty()) {
            handleEscape(g, u, (String) msg.mAtList.get(0));
            return;
        }
    }
    
    if (!en) {
        if (c.equals("æŠ½å¥–å¸®åŠ©")) {
            sendMsg(g, "", HELP_INFO);
        }
        return;
    }

    // å•†åº—ä¸ç‚¸å¼¹
    if (c.equals(SHOP_KEYWORD)) {
        handleShop(g, u);
        return;
    }
    if (c.equals(BUY_BOMB_KEYWORD)) {
        handleBuyBomb(g, u);
        return;
    }

    // ç‚¸å¼¹ä½¿ç”¨
    if (c.startsWith(BOMB_AT_KEYWORD) && msg.mAtList != null && !msg.mAtList.isEmpty()) {
        if (!dev && !checkBombInterval(g, u)) return;
        handleBomb(g, u, (String) msg.mAtList.get(0));
        return;
    }
    if (c.equals(BOMB_UP_KEYWORD)) {
        String t = (String) lastSpeakerMap.get(g);
        if (t == null || t.equals(u)) {
            sendMsg(g, "", MSG_PREFIX + "@" + getMemberName(g, u) + " âš ï¸ æ²¡æœ‰å¯ç‚¸çš„æ¥¼ä¸Šå“¦ï½");
            return;
        }
        if (isUserBanned(g, t)) {
            sendMsg(g, "", MSG_PREFIX + "@" + getMemberName(g, u) + " âš ï¸ æ¥¼ä¸Šå·²è¢«ç¦è¨€ï¼Œæ— æ³•è¢«ç‚¸ï½");
            return;
        }
        if (!dev && !checkBombInterval(g, u)) return;
        handleBomb(g, u, t);
        return;
    }
    if (c.equals(BOMB_DOWN_KEYWORD)) {
        if (pendingBombMap.containsKey(g)) {
            sendMsg(g, "", MSG_PREFIX + "@" + getMemberName(g, u) + " âš ï¸ å·²åœ¨ç­‰å¾…ç‚¸æ¥¼ä¸‹ï½");
            return;
        }
        pendingBombMap.put(g, u);
        sendMsg(g, "", MSG_PREFIX + "@" + getMemberName(g, u) + " âœ… å·²å‡†å¤‡ç‚¸æ¥¼ä¸‹ï¼Œä¸‹ä¸€ä½å‘è¨€è€…å°†è¢«æ”»å‡»ï½");
        return;
    }

    // å…¶ä»–æŒ‡ä»¤
    if (c.equals("æŠ½å¥–å¸®åŠ©")) {
        sendMsg(g, "", HELP_INFO);
        return;
    }
    if (c.equals("ç­¾åˆ°") || c.equals("å†’æ³¡")) {
        handleCheckin(g, u);
        return;
    }
    if (c.equals("æŠ½å¥–")) {
        if (!dev && !checkLotteryInterval(g, u)) return;
        int cnt = getDailyLotteryCount(g, u);
        handleLottery(g, u, u, calculateActualCost(SELF_LOTTERY_BASE, cnt), cnt);
        return;
    }
    if (c.startsWith("å¸®@") && c.endsWith("æŠ½å¥–") && msg.mAtList != null && !msg.mAtList.isEmpty()) {
        String t = (String) msg.mAtList.get(0);
        if (isUserBanned(g, t)) {
            sendMsg(g, "", MSG_PREFIX + "@" + getMemberName(g, u) + " âš ï¸ " + getMemberName(g, t) + " æ­£åœ¨ç¦è¨€ï½");
            return;
        }
        if (!dev && !checkLotteryInterval(g, u)) return;
        int cnt = getDailyLotteryCount(g, u);
        handleLottery(g, u, t, calculateActualCost(HELP_LOTTERY_BASE, cnt), cnt);
        return;
    }
    if (c.equals("æˆ‘çš„é‡‘å¸")) {
        onQueryMyCoins(g, u, 0);
        return;
    }
    if (c.startsWith("æŸ¥è¯¢@") && c.endsWith("é‡‘å¸") && msg.mAtList != null && !msg.mAtList.isEmpty()) {
        handleQueryOthersCoins(g, u, (String) msg.mAtList.get(0));
        return;
    }
}

// æ ¸å¿ƒå·¥å…·æ–¹æ³•
private void updateLastSpeaker(String g, String u) {
    lastSpeakerMap.put(g, u);
}
private void checkPendingBomb(String g, String u) {
    if (pendingBombMap.containsKey(g)) {
        String b = (String) pendingBombMap.get(g);
        if (!b.equals(u)) {
            handleBomb(g, b, u);
        }
        pendingBombMap.remove(g);
    }
}
private int calculateActualCost(int base, int cnt) {
    if (cnt <= DAILY_FREE_COUNT) {
        return base;
    } else {
        return base + (cnt - DAILY_FREE_COUNT);
    }
}
private int getDailyLotteryCount(String g, String u) {
    String k = g + "_" + u;
    String d = getString(USER_DAILY_LOTTERY, k, "0_0");
    String[] p = d.split("_");
    try {
        int c = Integer.parseInt(p[0]);
        long t = Long.parseLong(p[1]);
        if (isSameDay(t, System.currentTimeMillis())) {
            return c;
        } else {
            return 0;
        }
    } catch (Exception e) {
        return 0;
    }
}
private void updateDailyLotteryCount(String g, String u) {
    int newCount = getDailyLotteryCount(g, u) + 1;
    putString(USER_DAILY_LOTTERY, g + "_" + u, newCount + "_" + System.currentTimeMillis());
}

// åŠŸèƒ½å®ç°
private void handleShop(String g, String u) {
    sendMsg(g, "", MSG_PREFIX + "@" + getMemberName(g, u) + " ğŸ›’ é‡‘å¸å•†åº—ï¼š\n" +
        "â€¢ ç‚¸å¼¹ï¼š5é‡‘å¸/ä¸ª\n" +
        "å‘é€ã€Œè´­ä¹°ç‚¸å¼¹ã€å³å¯è´­ä¹°ï¼Œç‚¸äººåä¼šæç¤ºæ˜¯å¦æˆåŠŸç¦è¨€ï½");
}
private void handleBuyBomb(String g, String u) {
    int c = getUserCoins(g, u);
    String a = "@" + getMemberName(g, u);
    if (c < BOMB_COST) {
        sendMsg(g, "", MSG_PREFIX + a + " âš ï¸ é‡‘å¸ä¸è¶³ï¼éœ€è¦" + BOMB_COST + "ï¼Œå½“å‰ï¼š" + c);
        return;
    }
    setUserCoins(g, u, c - BOMB_COST);
    int b = getUserBombs(g, u) + 1;
    setUserBombs(g, u, b);
    sendMsg(g, "", MSG_PREFIX + a + " âœ… è´­ä¹°æˆåŠŸï¼\næ¶ˆè€—" + BOMB_COST + "ï¼Œè·å¾—1ä¸ªç‚¸å¼¹ï½\nå½“å‰ç‚¸å¼¹ï¼š" + b + "ï¼Œä½™é¢ï¼š" + (c - BOMB_COST));
}
private void handleBomb(String g, String b, String t) {
    int bm = getUserBombs(g, b);
    String a = "@" + getMemberName(g, b);
    String tn = getMemberName(g, t);
    if (bm < 1) {
        sendMsg(g, "", MSG_PREFIX + a + " âš ï¸ ç‚¸å¼¹ä¸è¶³ï¼å‘ã€Œå•†åº—ã€è´­ä¹°ï½");
        return;
    }
    setUserBombs(g, b, bm - 1);
    boolean hit = Math.random() * 100 < BOMB_TARGET_CHANCE;
    boolean dev = getBoolean(DEV_MODE, g, false);
    String res;
    if (hit) {
        res = "æˆåŠŸç‚¸ä¸­" + tn + "ï¼å·²ç¦è¨€1åˆ†é’Ÿï½";
    } else {
        res = "ç‚¸å¼¹åå¼¹ï¼è‡ªå·±å·²ç¦è¨€1åˆ†é’Ÿï½";
    }
    if (!dev) {
        Forbidden(g, hit ? t : b, BOMB_BAN_SECONDS);
    }
    sendMsg(g, "", MSG_PREFIX + a + " ğŸ’¥ " + res + (dev ? "ï¼ˆå¼€å‘è€…æ¨¡å¼ï¼‰" : "") + "\nå‰©ä½™ç‚¸å¼¹ï¼š" + (bm - 1));
}
private boolean checkBombInterval(String g, String u) {
    String k = g + "_" + u;
    long lt = getLong(BOMB_LAST_CONFIG, k, 0);
    long ct = System.currentTimeMillis();
    if (ct - lt < BOMB_INTERVAL) {
        long remain = (BOMB_INTERVAL - (ct - lt)) / 1000;
        sendMsg(g, "", MSG_PREFIX + "@" + getMemberName(g, u) + " â³ è¯·ç­‰" + remain + "ç§’å†ç”¨ç‚¸å¼¹ï½");
        return false;
    }
    putLong(BOMB_LAST_CONFIG, k, ct);
    return true;
}
private void handleEscape(String g, String o, String t) {
    String k = g + "_" + t;
    String d = getString(USER_ESCAPE_WINDOW, k, null);
    String a = "@" + getMemberName(g, o);
    if (d == null) {
        sendMsg(g, "", MSG_PREFIX + a + " âš ï¸ ç›®æ ‡æš‚æ— éœ€è¦å…æ­»çš„ç¦è¨€ï½");
        return;
    }
    String[] p = d.split(",");
    if (p.length != 3) {
        clearEscapeWindow(g, t);
        sendMsg(g, "", MSG_PREFIX + a + " âš ï¸ å…æ­»è¯·æ±‚å¼‚å¸¸ï½");
        return;
    }
    long st = Long.parseLong(p[0]);
    int bs = Integer.parseInt(p[1]);
    int he = Integer.parseInt(p[2]);
    long ct = System.currentTimeMillis();
    if (he == 1) {
        sendMsg(g, "", MSG_PREFIX + a + " âš ï¸ ç›®æ ‡å·²å®Œæˆå…æ­»ï½");
        return;
    }
    if (ct - st > ESCAPE_WINDOW) {
        clearEscapeWindow(g, t);
        sendMsg(g, "", MSG_PREFIX + a + " âš ï¸ å…æ­»çª—å£æœŸå·²è¿‡ï½");
        return;
    }
    int ec = getEscapeCost(bs);
    if (ec == -1) {
        clearEscapeWindow(g, t);
        sendMsg(g, "", MSG_PREFIX + a + " âš ï¸ é…ç½®å¼‚å¸¸ï½");
        return;
    }
    int oc = getUserCoins(g, o);
    if (oc < ec) {
        sendMsg(g, "", MSG_PREFIX + a + " âš ï¸ é‡‘å¸ä¸è¶³ï¼éœ€è¦" + ec + "ï¼Œå½“å‰ï¼š" + oc);
        return;
    }
    setUserCoins(g, o, oc - ec);
    putString(USER_ESCAPE_WINDOW, k, st + "," + bs + ",1");
    String log = o.equals(t) ? "ä¸ºè‡ªå·±å…æ­»ï¼" : "å¸®" + getMemberName(g, t) + "å…æ­»ï¼";
    sendMsg(g, "", MSG_PREFIX + a + " âœ… " + log + "\næ‰£é™¤" + ec + "é‡‘å¸ï¼Œå·²å…é™¤" + bs/60 + "åˆ†é’Ÿç¦è¨€ï½\nå‰©ä½™é‡‘å¸ï¼š" + (oc - ec));
}
private int getEscapeCost(int s) {
    for (int i = 0; i < BAN_SECONDS.length; i++) {
        if (BAN_SECONDS[i] == s) {
            return ESCAPE_COST_MAP[i];
        }
    }
    return -1;
}
private void openEscapeWindow(String g, String u, int s) {
    String k = g + "_" + u;
    long t = System.currentTimeMillis();
    putString(USER_ESCAPE_WINDOW, k, t + "," + s + ",0");
    sendMsg(g, "", MSG_PREFIX + "@" + getMemberName(g, u) + " âš ï¸ æŠ½ä¸­" + s/60 + "åˆ†é’Ÿç¦è¨€ï¼\n" +
        "ã€1åˆ†é’Ÿå†…æœ‰æ•ˆã€‘å‘é€ã€Œ" + ESCAPE_KEYWORD + "ã€æ‰£" + getEscapeCost(s) + "é‡‘å¸å…æ­»ï¼Œæˆ–è®©ä»–äººå‘ã€Œå¸®@æˆ‘" + ESCAPE_KEYWORD + "ã€ï½\n" +
        "è¶…æ—¶æœªæ“ä½œå°†è‡ªåŠ¨æ‰§è¡Œç¦è¨€ï¼");
    new Thread(new Runnable() {
        public void run() {
            try {
                Thread.sleep(ESCAPE_WINDOW);
                String d = getString(USER_ESCAPE_WINDOW, k, null);
                if (d == null) return;
                String[] p = d.split(",");
                if (p.length != 3) {
                    clearEscapeWindow(g, u);
                    return;
                }
                if (Integer.parseInt(p[2]) == 0 && !getBoolean(DEV_MODE, g, false)) {
                    Forbidden(g, u, s);
                    sendMsg(g, "", MSG_PREFIX + "@" + getMemberName(g, u) + " â° å…æ­»çª—å£æœŸå·²è¿‡ï¼Œæ‰§è¡Œ" + s/60 + "åˆ†é’Ÿç¦è¨€ï½");
                } else {
                    sendMsg(g, "", MSG_PREFIX + "@" + getMemberName(g, u) + " âœ… å·²é€šè¿‡å…æ­»æ“ä½œå…é™¤ç¦è¨€ï½");
                }
                clearEscapeWindow(g, u);
            } catch (Exception e) {}
        }
    }).start();
}
private void clearEscapeWindow(String g, String u) {
    putString(USER_ESCAPE_WINDOW, g + "_" + u, null);
}
private void handleCheckin(String g, String u) {
    String k = g + "_" + u;
    String a = "@" + getMemberName(g, u);
    long lt = getLong(USER_CHECKIN, k, 0);
    long ct = System.currentTimeMillis();
    int cd = getInt(USER_CONTINUOUS_CHECKIN, k, 1);
    if (isYesterday(lt, ct)) {
        cd++;
    } else if (!isSameDay(lt, ct)) {
        cd = 1;
    } else {
        sendMsg(g, "", MSG_PREFIX + a + " âš ï¸ ä»Šå¤©å·²ç­¾åˆ°ï½è¿ç»­" + cd + "å¤©");
        return;
    }
    int r = CHECKIN_REWARDS[Math.min(cd, CHECKIN_REWARDS.length - 1)];
    setUserCoins(g, u, getUserCoins(g, u) + r);
    putLong(USER_CHECKIN, k, ct);
    putInt(USER_CONTINUOUS_CHECKIN, k, cd);
    sendMsg(g, "", MSG_PREFIX + a + " âœ… ç­¾åˆ°æˆåŠŸï¼\nè¿ç»­" + cd + "å¤©ï¼Œè·å¾—" + r + "é‡‘å¸ï½\nå½“å‰ä½™é¢ï¼š" + getUserCoins(g, u));
}
public void onQueryMyCoins(String g, String u, int t) {
    int c = getUserCoins(g, u);
    int b = getUserBombs(g, u);
    int cnt = getDailyLotteryCount(g, u);
    sendMsg(g, "", MSG_PREFIX + "@" + getMemberName(g, u) + " ğŸ’° ä½ çš„èµ„äº§ï¼š\n" +
        "é‡‘å¸ï¼š" + c + "\nç‚¸å¼¹ï¼š" + b + "\nä»Šæ—¥å·²æŠ½å¥–ï¼š" + cnt + "æ¬¡\nä¸‹æ¬¡æŠ½å¥–æˆæœ¬ï¼š" + calculateActualCost(SELF_LOTTERY_BASE, cnt + 1) + "é‡‘å¸");
}
private void handleQueryOthersCoins(String g, String o, String t) {
    int c = getUserCoins(g, t);
    int cnt = getDailyLotteryCount(g, t);
    sendMsg(g, "", MSG_PREFIX + "@" + getMemberName(g, o) + " ğŸ” " + getMemberName(g, t) + " çš„ä¿¡æ¯ï¼š\n" +
        "é‡‘å¸ï¼š" + c + "\nä»Šæ—¥å·²æŠ½å¥–ï¼š" + cnt + "æ¬¡");
}
private boolean checkLotteryInterval(String g, String u) {
    String k = g + "_" + u;
    long lt = getLong(USER_LAST_LOTTERY, k, 0);
    long ct = System.currentTimeMillis();
    if (ct - lt < LOTTERY_INTERVAL) {
        long remain = (LOTTERY_INTERVAL - (ct - lt)) / 1000;
        sendMsg(g, "", MSG_PREFIX + "@" + getMemberName(g, u) + " â³ è¯·ç­‰" + remain + "ç§’å†æŠ½å¥–ï½");
        return false;
    }
    putLong(USER_LAST_LOTTERY, k, ct);
    return true;
}
private void handleLottery(String g, String o, String t, int c, int cnt) {
    boolean dev = getBoolean(DEV_MODE, g, false);
    String a = "@" + getMemberName(g, o);
    String tn = getMemberName(g, t);
    int oc = getUserCoins(g, o);
    if (!dev && oc < c) {
        sendMsg(g, "", MSG_PREFIX + a + " âš ï¸ é‡‘å¸ä¸è¶³ï¼æœ¬æ¬¡éœ€" + c + "ï¼Œå½“å‰ï¼š" + oc);
        return;
    }
    int acc = dev ? oc : oc - c;
    if (!dev) {
        setUserCoins(g, o, acc);
        updateDailyLotteryCount(g, o);
    }
    int bs = getInt(USER_CONTINUOUS_BAN, g + "_" + o, 0);
    int si;
    if (bs >= BAN_STREAK_LIMIT) {
        si = selectGoldRewardIndex();
        bs = 0;
    } else {
        si = randomRewardIndex();
        if (REWARD_TYPES[si] == 0) {
            bs++;
        } else {
            bs = 0;
        }
    }
    putInt(USER_CONTINUOUS_BAN, g + "_" + o, bs);
    if (REWARD_TYPES[si] == 0 && !dev) {
        openEscapeWindow(g, t, REWARD_VALUES[si]);
    } else if (REWARD_TYPES[si] == 1) {
        setUserCoins(g, t, getUserCoins(g, t) + REWARD_VALUES[si]);
    }
    int nc = calculateActualCost(o.equals(t) ? SELF_LOTTERY_BASE : HELP_LOTTERY_BASE, dev ? cnt : cnt + 1);
    String devTag = dev ? "[å¼€å‘è€…æ¨¡å¼] " : "";
    String resultPrefix = o.equals(t) ? "æŠ½å¥–ç»“æœï¼š" : "å¸®" + tn + "æŠ½å¥–ï¼Œç»“æœï¼š";
    String extraTip = (bs >= BAN_STREAK_LIMIT - 1 && REWARD_TYPES[si] == 0) ? "ï¼ˆå†æŠ½1æ¬¡ç¦è¨€å¿…ä¸­é‡‘å¸ï¼ï¼‰" : "";
    sendMsg(g, "", MSG_PREFIX + a + " " + devTag + resultPrefix +
        tn + " " + REWARD_NAMES[si] + (dev ? "ï¼ˆå¼€å‘è€…æ¨¡å¼ï¼‰" : "") + extraTip + "\n" +
        "æœ¬æ¬¡æ¶ˆè€—ï¼š" + c + "é‡‘å¸ | å‰©ä½™ï¼š" + (dev ? oc : (REWARD_TYPES[si] == 1 && o.equals(t) ? acc + REWARD_VALUES[si] : acc)) + "\n" +
        "ä»Šæ—¥å·²æŠ½ï¼š" + cnt + "æ¬¡ | ä¸‹æ¬¡æˆæœ¬ï¼š" + nc + "é‡‘å¸");
}

// éšæœºå¥–åŠ±æ–¹æ³•ï¼ˆä¿®å¤æ‹¬å·é”™è¯¯ï¼Œä½¿ç”¨æ ‡å‡†è¯­æ³•ï¼‰
private int randomRewardIndex() {
    int tw = 0;
    for (int w : REWARD_WEIGHTS) {
        tw += w;
    }
    int r = (int) (Math.random() * tw);
    int s = 0;
    for (int i = 0; i < REWARD_WEIGHTS.length; i++) {
        s += REWARD_WEIGHTS[i];
        if (r < s) {
            return i;
        }
    }
    return 0;
}
private int selectGoldRewardIndex() {
    int[] gi = {4, 5, 6, 7};
    int tw = 0;
    for (int i : gi) {
        tw += REWARD_WEIGHTS[i];
    }
    int r = (int) (Math.random() * tw);
    int s = 0;
    for (int i : gi) {
        s += REWARD_WEIGHTS[i];
        if (r < s) {
            return i;
        }
    }
    return 4;
}

// å·¥å…·æ–¹æ³•
private int getUserBombs(String g, String u) {
    return getInt(USER_BOMBS, g + "_" + u, 0);
}
private void setUserBombs(String g, String u, int b) {
    putInt(USER_BOMBS, g + "_" + u, b);
}
private boolean isGroupEnabled(String g) {
    return getBoolean(GROUP_ENABLED, g, false);
}
private int getUserCoins(String g, String u) {
    return getInt(USER_COINS, g + "_" + u, 0);
}
private void setUserCoins(String g, String u, int c) {
    putInt(USER_COINS, g + "_" + u, c);
}
private boolean isSameDay(long t1, long t2) {
    java.util.Calendar c1 = java.util.Calendar.getInstance();
    java.util.Calendar c2 = java.util.Calendar.getInstance();
    c1.setTimeInMillis(t1);
    c2.setTimeInMillis(t2);
    return c1.get(java.util.Calendar.YEAR) == c2.get(java.util.Calendar.YEAR) &&
        c1.get(java.util.Calendar.DAY_OF_YEAR) == c2.get(java.util.Calendar.DAY_OF_YEAR);
}
private boolean isYesterday(long lt, long ct) {
    java.util.Calendar l = java.util.Calendar.getInstance();
    java.util.Calendar c = java.util.Calendar.getInstance();
    l.setTimeInMillis(lt);
    c.setTimeInMillis(ct);
    return l.get(java.util.Calendar.YEAR) == c.get(java.util.Calendar.YEAR) &&
        l.get(java.util.Calendar.DAY_OF_YEAR) == c.get(java.util.Calendar.DAY_OF_YEAR) - 1;
}
private boolean checkClickValid() {
    long ct = System.currentTimeMillis();
    if (ct - lastClickTime < CLICK_DELAY) {
        return false;
    }
    lastClickTime = ct;
    return true;
}

// èœå•æ–¹æ³•
public void onEnableLottery(String g, String u, int t) {
    if (checkClickValid()) {
        putBoolean(GROUP_ENABLED, g, true);
        sendMsg(g, "", MSG_PREFIX + "@" + getMemberName(g, u) + " ğŸ‰ æœ¬ç¾¤æŠ½å¥–åŠŸèƒ½å·²å¼€å¯ï¼å‘ã€ŒæŠ½å¥–å¸®åŠ©ã€çœ‹è§„åˆ™ï½");
    }
}
public void onDisableLottery(String g, String u, int t) {
    if (checkClickValid()) {
        putBoolean(GROUP_ENABLED, g, false);
        sendMsg(g, "", MSG_PREFIX + "@" + getMemberName(g, u) + " âŒ æœ¬ç¾¤æŠ½å¥–åŠŸèƒ½å·²å…³é—­");
    }
}
public void onEnableDevMode(String g, String u, int t) {
    if (checkClickValid()) {
        putBoolean(DEV_MODE, g, true);
        sendMsg(g, "", MSG_PREFIX + "@" + getMemberName(g, u) + " ğŸ”§ å¼€å‘è€…æ¨¡å¼å·²å¼€å¯");
    }
}
public void onDisableDevMode(String g, String u, int t) {
    if (checkClickValid()) {
        putBoolean(DEV_MODE, g, false);
        sendMsg(g, "", MSG_PREFIX + "@" + getMemberName(g, u) + " ğŸ”§ å¼€å‘è€…æ¨¡å¼å·²å…³é—­");
    }
}

// ç©ºæ–¹æ³•ä¿ç•™
private void checkAllBannedStatus(String g) {}
private void checkAllEscapeWindowTimeout(String g) {}
private void markUserBanned(String g, String u, int s) {
    putLong(USER_BANNED, g + "_" + u, System.currentTimeMillis() + s * 1000);
}
private boolean isUserBanned(String g, String u) {
    return getLong(USER_BANNED, g + "_" + u, 0) > System.currentTimeMillis();
}

init();
